\chapter{Introduction} \label{cha:introduction} %\thispagestyle{main}
The progress of diagnostic imaging has advanced significantly during the \nth{20} century. As the cost of high-speed computational systems has grown increasingly accessible, so has the use of medical imaging become prominent. Millions of people have potentially been spared painful exploratory surgery through non-invasive diagnostic imaging. Thus, lives can be saved by early diagnosis and intervention through medical imaging. Advancements in scientific visualisation have in turn generated more complex data-sets of increased size and quality. The four major technologies used are \gls{us}, X-ray, \gls{ct}, and \gls{mri}. Each technology has distinct advantages and disadvantages in biomedical imaging, and thus each is still relevant for modern medicine. \Cref{tab:1_imagingmodalities} contains a comparison and summary of the various fundamental diagnostic imaging modalities.

\begin{table}[htbp]
	\centering
	\begin{talltblr}[
	caption = {Comparison of medical imaging modalities \cite{Szabo_UltrasoundBook_2}},
	entry = {Comparison of medical imaging modalities},
	label = {tab:1_imagingmodalities},
	note{a} = {Frequency and axially dependent.},
	note{b} = {Frequency dependent.},
	note{c} = {Fluoroscopy limited.},
	note{$\dag$} = {Typical: 45 minutes, fastest: Real-time (\glsxtrshort{low-res}).},
	]{
		%colspec = {Q[l,t]Q[l,t]Q[l,t]Q[l,t]Q[l,t]},
		%colspec = {Q[jQQQQ},
		row{1} = {guard, m, font=\small\bfseries},
	}
	\toprule
	\textbf{Modality} & \textbf{Ultrasound} & \textbf{X-ray} & \textbf{CT} & \textbf{MRI} \\ \midrule
	Topic             & {Longitudinal,\\shear,\\mechanical\\properties} & {Mean X-ray\\tissue\\absorption} & {Local tissue\\X-ray absorbtion} & {Biochemistry \\(\textit{T1} and \textit{T2})}    \\
	Access            & {Small\\windows\\adequate} & {2 sides\\needed} & {Circumferential\\around\\body} & {Circumferential\\around\\body} \\
	{Spatial\\resolution} & {\qty{0.2}{\milli\meter} to\\\qty{3}{\milli\meter}\TblrNote{a}} & $\sim \qty{1}{\milli \meter}$ & $\sim \qty{1}{\milli \meter}$ & $\sim \qty{1}{\milli \meter}$ \\
	Penetration     & {\qty{3}{\centi\meter} to\\\qty{25}{\centi\meter}\TblrNote{b}} & Excellent  & Excellent & Excellent \\
	Safety          & Excellent & {Ionizing\\radiation}      & {Ionizing\\radiation} & Very good \\
	Speed           & Real-time & Minutes & 20 minutes & Varies\TblrNote{$\dag$} \\
	Cost            & \$ & \$ & \$\$ & \$\$\$ \\
	Portability     & Excellent & Good & Poor & Poor \\
	{Volume\\coverage} & {Real-time\\3D volumes,\\improving} & 2D & {Large 3D\\volume} & {Large 3D \\volume} \\
	Contrast        & {Increasing\\(shear)} & Limited & Limited & {Slightly\\flexible} \\
	Intervention    & {Real-time\\3D increasing} & No\TblrNote{c} & No & Yes, limited \\
	Functional      & {Functional\\ultrasound} & No & No & fMRI \\
	\bottomrule
\end{talltblr}
\end{table}

Between 2004 and 2016\todo{Fix end year}, medical imaging has been reported to have been performed more than 5 billion times \cite{Picano2004}. Later numbers from 2011 show a general doubling and in particular, a tenfold increase in ultrasound examinations between 2000 and 2011 \cite{Szabo_UltrasoundBook_2}. Recent data reveal that this trend of doubling has continued throughout the years 2010 to 2020 \cite{Winder2021}, and reveal that even though patient processes were disrupted during the global SARS-CoV-2 pandemic, the number of medical imaging examinations per 1000 patients still increased. The reasons for this and, particularly, why ultrasound has seen a significant increase in use, can be attributed to its high resolution, cost-effectiveness, portability, and real-time interventional imaging. The downside of ultrasound is its limited penetration, restrictions for use in certain body parts, and inconsistent resolution. When comparing soft tissue examinations, which ultrasound is limited to, both \gls{ct} and \gls{mri} can image the entire body with consistent resolution and contrast, but are more expensive and have poor portability due to the immense size of their hardware.

The cardiovascular system, which transports oxygen and nutrients to tissue, produces a complex flow pattern that causes velocity fluctuations. Several \gls{cvd} are also known to cause abnormal blood flow. In studies published by the Centers for Disease Control, a person dies from CVD every 34 seconds in the United States and complications from CVD cost 229 billion USD between 2017 and 2018 \cite{cdc_2022}. As mentioned above, ultrasound is a powerful tool for performing non-invasive imaging of the cardiovascular system \cite{JensenUltrasoundBook,Hansen_thesis}, and has no adverse risk to patients. Determining \gls{psd} of a received signal is a common way to estimate blood velocity. A processed image of \gls{psd} over time is commonly known as a sonogram, where changes in blood velocity over time can be seen.\todo{Check over-time repetitive}

\section{Literature review}
%The aim of this project is to study the application of ultrasound in the context of blood flow measurements. Various scientific articles have been studied to gain knowledge of previous research \cite{Jensen_Analysis_PW_1996,Jansson_Estimation_Perfusion,Huang_Smartphone_2012,JanaSmartphone2020,DingPMUTs,Ding_PW_Pmut,Xu2007_Pulser,Matsuoka_Doppler_Rabbit,Fish_Ultrasonic,Williams2006,Winckler2012,Wang2016,Wang2019,Tsang2009,Govindan2016,Xu2007_Pulser,PICpulser}. In addition, textbooks \cite{JensenUltrasoundBook,ShungUltrasound_Book,Szabo_UltrasoundBook_2} have also been instrumental in forming a solid knowledge base for the thesis.

%The delimitation of this work is done through a literature review in the field of blood flow estimation using ultrasound. One of the earliest concepts for a device to estimate and study blood flow using ultrasound was developed during the 1950s in Japan and published internationally by \cite{Satomura_CW}. In this journal article, \citeauthor{Satomura_CW} study the valvular movements using echocardiography and made several important discoveries on the distinctions in myocardial change between healthy patients and patients suffering from \gls{cvd}. Articles such as \cite{Jensen_Analysis_PW_1996,Wells1998,PWDesignParameters,Jansson_Estimation_Perfusion,PWDesignParameters} outline the Doppler ultrasound analysis.
A systematic review was conducted using PubMed, Google Scholar, Elsevier, DTU FindIt and IEEE Xplore with the search terms \enquote{pulsed-wave Doppler ultrasound}, \enquote{blood velocity estimation}, and \enquote{ultrasound flow-meter}. The search was limited to English-language articles. The literature search yielded more than 50 papers, of which 37 were studied for the purpose of learning from the contents \cite{Satomura_CW,Baker1970,Shung1976,Schlindwein1988,Hall_Wall_Filter,Jensen_Analysis_PW_1996,Wells1998,PWDesignParameters,Jansson_Estimation_Perfusion,Hoskins_Review_Blood_Velocity,Fish_Ultrasonic,Jensen_Algorithms,cmut_array_shape,Williams2006,Tsang2009,Matsuoka_Doppler_Rabbit,Hoskins2010,PICpulser,Advances_BloodFlow_Velocity,Overview_Emerging_Imaging,Huang_Smartphone_2012,DesignDocument,Winckler2012,Sagdiev2014,Jacinta_string_phantom,500Vpulser,Wang2016,Govindan2016,Wang2019,JanaSmartphone2020,Ding_PW_Pmut,DingPMUTs,Winder2021,Omura2022,2023_review,Ricci2018,Bessi1995}. In addition, textbooks \cite{JensenUltrasoundBook,ShungUltrasound_Book,Szabo_UltrasoundBook_2} were used in the preparation and study of the theoretical principles of biomedical imaging and ultrasound.

Among these works are some of the earliest papers that outlined the field as it was emerging. Other articles study the possibilities of improvements in algorithms and experimental parameters. Overall, the results indicate that the Doppler flow meter is a reliable method for estimating blood flow velocity in various parts of the body. Studies include experiments using physiological simulators and in-vivo on humans and animals alike. Some of the review articles have compared Doppler flow-meters to other imaging techniques for this application, such as magnetic resonance imaging and computed tomography angiography, and have shown that the Doppler flow-meter is a cost-effective, portable and non-invasive choice.
%
%\begin{table}[htbp]
%	\centering
%	\begin{adjustbox}{max width=\textwidth}
%	\begin{talltblr}[
%		caption={Comparison of papers in literature study},
%		entry={Comparison of papers in literature study},
%		label={tab:1_papercomparison}]{
%			row{1} = {guard, m, font=\small\bfseries},
%		}
%		\toprule
%		Author & Architecture & Type & Power & System Components & DSP & Metrics & Output & Validation \\
%		\midrule
%		\citeauthor{Huang_Smartphone_2012} \cite{Huang_Smartphone_2012} & {\gls{pw},\\\qty{10}{\mega\hertz}} & Smartphone & \qty{12}{\volt} & {\gls{prf} timer, bipolar\\pulser, quadrature\\demodulation, \gls{sha}} & 512 point \gls{fft} & Doppler spectrogram & Microphone auxiliary signal to smartphone & In-vivo animal experiment \\
%		\citeauthor{JanaSmartphone2020} \cite{JanaSmartphone2020} & {\gls{cw},\\\qty{8}{\mega\hertz}} & {Portable\\device} & \qty{12}{\volt} & \gls{rf} amplifier, envelope detection, \gls{lp} filter, preamplifier, \gls{adc} & 512 point \gls{fft} & \gls{ml} performance estimator on humans \\
%		\citeauthor{DingPMUTs} \cite{DingPMUTs} & {\gls{pw},\\\qty{3.7}{\mega\hertz}} & Smartphone & {Details not\\available} & {Function generator, \gls{rf}\\amplifier, quadrature demodulation,\\\gls{sha}, \gls{bp} filter,\\\gls{daq} module, LabVIEW} & {\gls{fft} size\\not mentioned} & {Physiological simulation\\using blood mimicking fluid\\in pumped tubing system} \\
%		\bottomrule
%	\end{talltblr}
%	\end{adjustbox}%
%\end{table}

\begin{table}
	\centering
	\begin{adjustbox}{max width=\textwidth}
		\begin{talltblr}[
			caption={Comparison of papers in literature study},
			entry={Comparison of papers in literature study},
			label={tab:1_papercomparison}]{
				row{1} = {guard, m, font=\small\bfseries},
			}
			\toprule
			& \citeauthor{Huang_Smartphone_2012} \cite{Huang_Smartphone_2012} & \citeauthor{JanaSmartphone2020} \cite{JanaSmartphone2020} & \citeauthor{DingPMUTs} \cite{DingPMUTs} \\
			\midrule
			Architecture & {PW \qty{10}{\mega\hertz}} & {CW \qty{8}{\mega\hertz}} & {PW \qty{3.7}{\mega\hertz}} \\
			Type & Smartphone & Portable device & Computer \\
			Power & 12 V & 12 V & Details not available \\
			Components & {PRF timer,\\bipolar pulser,\\quadrature demodulation,\\SHA} & {RF amplifier,\\envelope detection,\\LP filter, FPGA,\\preamplifier, ADC} & {AFG, RF amplifier,\\quadrature demodulation,\\SHA, BP filter}\\
			DSP & 512 pt FFT & 512 pt FFT & FFT size not mentioned \\
			Metrics & Doppler spectrogram & Haemodynamic parameters & Doppler spectrogram \\
			Output & Aux microphone signal & Bluetooth & {DAQ input signal \\ (LabVIEW)} \\
			Validation & In-vivo animal experiment & ML evaluation on humans & Physiological simulator \\
			\bottomrule
		\end{talltblr}
	\end{adjustbox}%
\end{table}
Of the selected papers studied in this project, three papers are distinctly relevant for the design and implementation of a blood velocity estimation system. A comparison between these three papers can be seen in \cref{tab:1_papercomparison}. Based on the literature review, a gap is identified in the acquisition method of the signal chain. A number of articles studied and developed the algorithms for blood flow estimation and imaging, but do did have an \gls{afe} and used offline data acquisition methods which are not usable for clinicians. The selected three articles all feature an online data acquisition method using various methods of data capture. There is a potential to using selected features from all three articles in a combination to achieve a positive result. For instance, the \gls{afe} in \citeauthor{Huang_Smartphone_2012} is better documented than both other papers, and feature a \gls{pw} design that could be useful. On the other hand, their solution for the pulser is dated and use inflexible discrete timer \gls{ic}s. \citeauthor{JanaSmartphone2020} use a \gls{cw} based design and thus most details are on the receiver. However, it features an \gls{fpga} \gls{soft microprocessor} design to the \gls{fft} engine. \citeauthor{DingPMUTs} feature a \gls{pw} design, and use an \gls{afg} as the primary signal generator for the pulser as well as the demodulation clock. In that paper, there are some good figures for studying the pulse-echo waveforms of the \gls{pw} type system.

Some of the project decisions resulting out of the study of these three papers include the desire to implement an \gls{afe} for a pulsed-wave system using the inspiration from all three papers, but also implement a novel pulse generator not using discrete \gls{ic}s or with a lab instrument \gls{afg}, since it is not portable. Instead, with a flexible and configurable design that an embedded system enables.

\section{Project scope}
%The desire is to build upon the vast knowledge already gathered by prominent researchers in the field of ultrasound systems for blood velocity estimation. Finally, using the knowledge gained, we designed and implemented an electronic device capable of performing these measurements using a novel approach. The system used in this project is called an Ultrasound Doppler flow-meter. Ultrasound Doppler flow-meters can be used to measure the velocity of blood flow in the human body. This is commonly done to assess the health of blood vessels and to diagnose and monitor conditions such as arteriosclerosis (hardening of the arteries) and deep vein thrombosis (blood clots in the veins). To measure blood velocity with an ultrasound Doppler flow-meter, a handheld probe is placed on the skin over the area of interest, such as an artery or vein. The probe contains a transducer that emits high-frequency ultrasound waves and receives the reflected waves. The Doppler shift in the frequency of the reflected waves is caused by the movement of the blood cells, and it is proportional to the velocity of the blood flow. The probe is connected to a portable ultrasound machine, which processes the Doppler shift and displays the velocity of the blood flow on a screen. The machine can also produce a color-coded map of the blood flow, which allows the user to visualize the velocity of the blood at different points within the vessel. Ultrasound Doppler flow-meters are non-invasive and safe to use, and they provide a quick and easy way to measure blood velocity. However, they are not always accurate, especially in cases where there is a high degree of turbulence or when there are air bubbles or solid particles present in the blood. They are also limited in their ability to measure blood flow in small vessels or in deep tissues. The goals of the project are written in \cref{tab:specifications}.

\begin{table}[htbp]
	\centering
	\caption{Project specification}
	\label{tab:specifications}
	\begin{tblr}[]{%
			%width=.9\textwidth,
			colspec = {l
			},
			row{1} = {guard, m, font=\small\bfseries},
			%vlines, hlines,
		}
		\toprule
		Project specification	\\
		\midrule
		Study and research ultrasound and its principles and applications	\\
		Design and implement a device for ultrasound blood velocity estimation	\\
		Investigate and test the device in an experimental setting		\\
		Validate results with commercial equipment 						\\
		Make quantifiable performance measurements on the system			\\
		Write a technical report documenting the project work			\\ \bottomrule
	\end{tblr}
\end{table}

A list of project goals is provided in \cref{tab:specifications}. The project is conducted under the guidance of advisors from the affiliated institutions \Gls{dtu}, Department of Electrical Engineering, Department of Applied Mathematics and Computer Science, and \Gls{kaist} at the Brain/Bio Medical Microsystems Laboratory. \todo{Omskriv til lab før uni} The report is divided into five chapters, and the first part is an introduction to the project. The second chapter will focus on explaining the theory of the topic of the project. The third chapter focuses on the synthesis of a system model for experimental testing. The fourth chapter explains the method of implementation during the assembly of the system. The fifth chapter will explain the testing methodology performed on the hardware. Finally, additional documentation of testing, code, circuit diagrams, and laboratory setups can be found in the appendix.

\begin{figure}[htbp]
	\centering
	\begin{adjustbox}{max width=\textwidth}

	\begin{ganttchart}[%Specs
	x unit=0.8cm,
	y unit title=0.5cm,
	y unit chart=0.5cm,
	vgrid,
	title height=1,
	title/.style={fill=lightgray},
	title label font=\bfseries\footnotesize,
	bar/.style={fill=cyan},
	bar height=0.7,
	%   progress label text={},
	group right shift=0,
	group top shift=0.7,
	group height=.3,
	group peaks width={0.2},
	inline]{1}{9}
	%labels
	\gantttitle{M.S. Thesis Research Schedule}{9}\\  % title 1
	%			\gantttitle[]{2021}{6}                 % title 2
	\gantttitle[]{2022}{3}
	\gantttitle[]{2023}{6} \\
	%			\gantttitle{Q3}{3}
	%			\gantttitle{Q4}{3}
	%			\gantttitle{Q1}{3}
	%			\gantttitle{Q2}{3}
%	\gantttitle{7}{1}
%	\gantttitle{8}{1}
%	\gantttitle{9}{1}
	\gantttitle{10}{1}
	\gantttitle{11}{1}
	\gantttitle{12}{1}
	\gantttitle{1}{1}
	\gantttitle{2}{1}
	\gantttitle{3}{1}
	\gantttitle{4}{1}
	\gantttitle{5}{1}
	\gantttitle{6}{1} \\
	%			\gantttitle{Q3}{3}
	%			\gantttitle{Q4}{3}
	%			\gantttitle{Q1}{3}
	%\gantttitle{Q2}{3} \\
	% Setting group if any
	%			\ganttgroup[inline=false]{Phase 1 (Basic Research)}{1}{6}\\
	%			\ganttbar[inline=false]{Study}{1}{3} \\
	%			\ganttbar[inline=false]{Laboratory experiments}{2}{4} \ganttbar[inline=false]{Laboratory experiments}{6}{6} \\
	%			\ganttbar[inline=false]{Initial PCB design}{2}{5}\\
	%			\ganttmilestone[inline=false]{End-of-Year 2021 Milestone}{6} \\

	\ganttgroup[inline=false]{Electronics}{1}{7} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Ultrasound switch}{1}{2} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Band-pass filter}{3}{3} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Power stage}{3}{4} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Preamplifier, Demodulator, Low-pass filter}{4}{5} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Sample-and-hold amplifier}{6}{6} \\
	\ganttbar[progress=100,progress label text={},inline=false]{High-pass filter}{6}{7} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Unit testing}{1}{7} \\
	\ganttgroup[inline=false]{Embedded}{4}{9} \\
	\ganttbar[progress=100,inline=false, progress label text={}]{Ultrasound pulser}{4}{7} \\
	\ganttbar[progress=25,progress label text={},inline=false]{Data processing}{8}{8} \\
	%			\ganttmilestone[inline=false]{Applied Study Completed Milestone}{3} \\
	\ganttgroup[inline=false]{Miscellaneous}{1}{8} \\
	\ganttbar[progress=25,progress label text={},inline=false]{Doppler experiments}{2}{4} \\
	\ganttbar[progress=100,progress label text={},inline=false]{Writing project report}{1}{8}\\
	\ganttmilestone[inline=false]{Deadline}{8}
\end{ganttchart}
\end{adjustbox}%
\caption{Gantt chart of project schedule}
\label{fig:gantt_chart}
\end{figure}